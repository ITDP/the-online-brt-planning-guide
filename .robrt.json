{
	"prepare" : {
		"dockerfile" : {
			"type" : "path",
			"data" : ".robrt.Dockerfile"
		}
	},
	"build" : {
		"cmds" : [
			"export DOCKER_HOST_IP=$(route -n | awk '/UG[ \t]/{print $2}')",
			"echo $GL_ANALYTICS_UA_ID",
			"echo $ASSET_URL_PREFIX",
			"echo $DOCKER_HOST_IP",
			"echo $FORCE_GREY_FAVICON",

			"dpkg -s haxe",
			"node --version",

			"haxelib --global install hmm",
			"haxelib --global run hmm setup",
			"haxelib --global list",

			"hmm install",
			"haxelib list",

			"cd $ROBRT_REPOSITORY_DIR",
			"if [ -z ${NO_CAP_GH_TOKEN+x} ]; then echo Skipped; else git remote set-url origin https://$NO_CAP_GH_TOKEN:$NO_CAP_GH_TOKEN@github.com/ITDP/the-online-brt-planning-guide; fi",
			"git lfs pull 2>&1 | tee .lfs-pull.log || echo \"error exit code: $?\" >> .lfs-pull.log",
			"git lfs logs last 2>&1 | tee .lfs-logs-last.log",
			"grep -qi 'no logs to show' .lfs-logs-last.log",
			"! grep -qi 'error\\|\\(batch response\\)' .lfs-pull.log",

			"cd $ROBRT_REPOSITORY_DIR/generator",
			"haxe -D travis build.hxml",
			"npm pack",
			"npm install -g manu*.tgz",
			"manu unit-tests",
			"mkdir -p $ROBRT_OUTPUT_DIR/bin",
			"cp manu*.tgz $ROBRT_OUTPUT_DIR/bin/",

			"cd $ROBRT_REPOSITORY_DIR",
			"cp LICENSE.md $ROBRT_OUTPUT_DIR/",
			"export DEBUG=1",
			"export TEX_NO_POSITIONS=1",
			"favicon=grey",
			"if [ \"${FORCE_GREY_FAVICON}\" -eq 1 ]; then echo Skipped; elif [ \"${ROBRT_IS_PR}\" -eq 1 ]; then favicon=red; elif [ \"${ROBRT_HEAD}\" = master ]; then favicon=green; fi",
			"cp guide/{itdp_$favicon,favicon}.ico",
			"manu generate guide/index.manu .generated",
			"find guide -type f -iname '*.manu' -print0 | xargs -0 manu stat tokens",

			"if [ -z ${ASSET_URL_PREFIX+x} ]; then echo Skipped; else manu asset-server store $DOCKER_HOST_IP 6668 .generated/html/assets; fi",
			"if [ -z ${ASSET_URL_PREFIX+x} ]; then echo Skipped; else rm -rf .generated/html/assets; fi",
			"cp -r .generated/html $ROBRT_OUTPUT_DIR/guide",
			"unset DEBUG",

			"ls -l .generated/pdf/fonts",
			"cd .generated/pdf/",
			"find assets/mw -type f \\( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' \\) -exec convert '{}' -resize '236>' '{}' \\;",
			"find assets/tw -type f \\( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' \\) -exec convert '{}' -resize '608>' '{}' \\;",
			"find assets/fw -type f \\( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' \\) -exec convert '{}' -resize '903>' '{}' \\;",
			"latexmk -lualatex -pdflatex='lualatex -interaction=nonstopmode' book.tex",
			"mkdir -p $ROBRT_OUTPUT_DIR/pdf $ROBRT_OUTPUT_DIR/guide/pdf",
			"cp book.pdf $ROBRT_OUTPUT_DIR/guide/pdf/the-brt-planning-guide.pdf",
			"cp book.log $ROBRT_OUTPUT_DIR/pdf/guide_lualatex.log"
		]
	}
}

