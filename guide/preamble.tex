\documentclass[twoside, 8pt]{extreport}

% monkey-patching tools
\usepackage{etoolbox}

% checks for xetex, luatex or either
\usepackage{ifxetex,ifluatex}
\newif\ifxelua
\ifxetex
	\xeluatrue
\else\ifluatex
	\xeluatrue
\else
	\xeluafalse
\fi\fi

% fonts, languages and encoding
% TODO make paths relative to the preamble, not the generated book
\ifxelua
	\usepackage{fontspec}
	\defaultfontfeatures{
		Ligatures = {TeX}
	}
	\setmainfont{PTF}[  % PT Serif Regular
		Path = ../fonts/PTSerif/,
		UprightFont = *55F,
		BoldFont = *75F,
		ItalicFont = *56F,
		BoldItalicFont = *76F
	]
	\setsansfont{PTS}[  % PT Sans Regular
		Path = ../fonts/PTSans/,
		UprightFont = *55F,
		BoldFont = *75F,
		ItalicFont = *56F,
		BoldItalicFont = *76F
	]
	\setmonofont{PTM}[  % PT Mono Regular
		Path = ../fonts/PTMono/,
		UprightFont = *55F,
		BoldFont = *75F,
	]
	\newfontfamily\familycaprm{PTZ}[  % PT Serif Caption Regular
		Path = ../fonts/PTSerif/,
		UprightFont = *55F,
		ItalicFont = *56F,
	]
	\newfontfamily\familycapsf{PTC}[  % PT Sans Caption Regular
		Path = ../fonts/PTSans/,
		UprightFont = *55F,
		BoldFont = *75F,
	]
	\newfontfamily\familynsf{PTN}[  % PT Sans Narrow Regular
		Path = ../fonts/PTSans/,
		UprightFont = *57F,
		BoldFont = *77F,
	]
	\usepackage{polyglossia}
	\setdefaultlanguage{english}
\else
	% compatibility with regular pdftex is desired, even if only for tests
	\usepackage[utf8]{inputenc}
	\usepackage[T1]{fontenc}
	\let\familycaprm\rmfamily
	\let\familycapsf\sffamily
	\let\familycapnsf\sffamily
	\usepackage{paratype}
	\usepackage[main=english]{babel}
\fi

%font style
\let\emphasis\textit
\let\highlight\textbf
\let\code\texttt

%pagesize
\usepackage{geometry}
\geometry{a4paper,total={105mm,243mm},left=35mm,top=18mm,marginparsep=7mm,marginparwidth=49mm,headsep=5.5mm,footskip=9mm}

%header & footer
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[LE]{\nouppercase\footnotesize\textsf{\color{gray25}BRT Planning Guide}}
\fancyhead[RO]{\nouppercase\footnotesize\textsf{\color{gray25}\leftmark}}
\fancyfoot[LE,RO]{\color{gray25}\thepage}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\chaptermark}[1]{\markboth{#1}{}}
\fancypagestyle{plain}{\fancyhf{}}

%colors
\usepackage{xcolor}
\definecolor{gray75}{gray}{0.25}
\definecolor{gray50}{gray}{0.5}
\definecolor{gray25}{gray}{0.75}
\definecolor{greenbrt}{cmyk}{0.75,0,0.75,0.25}

%headings
\usepackage{titlesec}
\titleformat{\part}[display]{\centering\bfseries\huge\color{greenbrt}\familycapsf}{VOLUME \thepart}{0pt}{}[]
\titleformat{\chapter}[display]{\bfseries\LARGE\color{greenbrt}\familycapsf}{}{0pt}{\thechapter.\ }[]
\titleformat*{\section}{\bfseries\Large\color{greenbrt}\familycapsf}
\titleformat*{\subsection}{\bfseries\large\color{greenbrt}\sffamily}
\titleformat*{\subsubsection}{\bfseries\color{greenbrt}\sffamily}
\titlespacing*{\chapter}{0mm}{0mm}{2.25mm plus 2.25mm}[0pt]
\titlespacing*{\section}{0mm}{4.5mm plus 4.5mm}{2.25mm plus 2.25mm}[0pt]
\titlespacing*{\subsection}{0mm}{2.25mm plus 2.25mm}{0mm plus 2.25mm}[0pt]
\titlespacing*{\subsubsection}{0mm}{2.25mm plus 2.25mm}{0mm plus 2.25mm}[0pt]
\let\volume\part

%workaround for titlesec 2.10.1 issue with missing labels
%http://tex.stackexchange.com/a/300259/46436
\makeatletter
\patchcmd{\ttlh@hang}{\parindent\z@}{\parindent\z@\leavevmode}{}{}
\patchcmd{\ttlh@hang}{\noindent}{}{}{}
\makeatother

%box
\usepackage{mdframed}
\newcommand{\boxtitle}[2]{{\noindent\bfseries\color{greenbrt}\familycapsf Box \thechapter.#1. #2} \\ }
\mdfsetup{innerleftmargin=6.75mm,innerrightmargin=6.75mm,innertopmargin=6.75mm,innerbottommargin=6.75mm,skipabove=4.5mm,skipbelow=4.5mm,linewidth=0.25mm,linecolor=gray50}
\def\beginbox{
	\mdframed[usetwoside=false]
	\parskip=0pt
	\baselineskip=4.5mm
	\parindent=7mm
	\color{gray50}
	}
\def\endbox{\endmdframed}
	
%list
\usepackage{enumitem}
\setlist{nolistsep,leftmargin=7mm,rightmargin=7mm}
\labelindent=7mm

%images - img {width}{filename} - fignote{figure number}{text}{credits}
\usepackage{graphicx}
\newcommand{\img}[2]{\noindent\includegraphics[width=#1]{#2} \\}
\newcommand{\fignote}[3]{\noindent\raggedright\footnotesize\sffamily\color{gray50}{\bfseries Figure \thechapter.#1.} #2 {\itshape #3} \par}

%quotation {quote}{name, about, 1900 - 2000}
\renewcommand{\quotation}[2]{\begingroup\leftskip=14mm\rightskip=14mm {\small\color{gray50} \noindent\textit{``#1''} \\\hbox{}\hfill --- #2} \par\endgroup \smallskip }

%tables
%note: \tablemodule*46 must match \textwidth+\marginparsep+\marginparwidth
\usepackage{ifoddpage}
\newdimen\tablemodule \tablemodule=\textwidth \divide\tablemodule by 30
\newcommand{\tabletitle}[2]{{\noindent\bfseries\color{greenbrt}\sffamily Table \thechapter.#1. #2} \par }
\newcommand{\tablesource}[1]{\noindent\raggedright\footnotesize\sffamily\color{gray50}{\bfseries Source:} #1 \par \smallskip}

\AtBeginDocument{
	\parskip=0mm plus 4.5mm
	\baselineskip=4.5mm
	\parindent=7mm
	\color{gray75}
}

%tmp
\usepackage{lipsum}

